// Prisma Schema for Figure E-Commerce Platform
// Prisma Version: 6.18.0
// PostgreSQL Version: 18 (compatible with 14+)
// Learn more: https://pris.ly/d/prisma-schema

// Prisma Client Generator
// Generates TypeScript types and query methods
generator client {
  provider = "prisma-client-js"
}

// PostgreSQL Database Connection
// Supports PostgreSQL 12+ (optimized for PostgreSQL 18)
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  STAFF
  CUSTOMER
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PACKED
  SHIPPING
  DELIVERED
  CANCELLED
  RETURNED
}

enum PaymentMethod {
  COD
  VNPAY
  BANK_TRANSFER
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id                 String   @id @default(uuid())
  username           String   @unique
  password           String
  email              String   @unique
  phoneNumber        String?
  fullName           String?
  avatar             String?
  resetPasswordToken String?
  role               UserRole
  address            String?
  isDelete           Boolean  @default(false)
  active             Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  addressBooks         AddressBook[]
  orders               Order[]
  reviews              Review[]
  chatRoomsAsCustomer  ChatRoom[]            @relation("CustomerChatRooms")
  chatRoomParticipants ChatRoomParticipant[]
  sentMessages         Message[]             @relation("SentMessages")
}

// ============================================
// PRODUCT CATALOG
// ============================================

model Category {
  id           String   @id @default(uuid())
  categoryName String
  image        String?
  description  String?
  isDelete     Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  products Product[]

  @@index([categoryName])
}

model Brand {
  id          String   @id @default(uuid())
  brandName   String
  image       String?
  description String?
  isDelete    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products Product[]

  @@index([brandName])
}

model Product {
  id           String   @id @default(uuid())
  productName  String
  price        Decimal  @db.Decimal(10, 2)
  description  String?
  discount     Decimal  @default(0) @db.Decimal(10, 2)
  badge        String?
  stock        Int      @default(0)
  isNewProduct Boolean  @default(false)
  isSale       Boolean  @default(false)
  isSpecial    Boolean  @default(false)
  isDelete     Boolean  @default(false)
  categoryId   String
  brandId      String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  category     Category           @relation(fields: [categoryId], references: [id])
  brand        Brand              @relation(fields: [brandId], references: [id])
  images       ProductImage[]
  variations   ProductVariation[]
  reviews      Review[]
  orderDetails OrderDetail[]

  @@index([categoryId])
  @@index([brandId])
  @@index([productName])
  @@index([isNewProduct])
  @@index([isSale])
  @@index([isSpecial])
}

model ProductImage {
  id        String   @id @default(uuid())
  imageUrl  String
  isDelete  Boolean  @default(false)
  isDefault Boolean  @default(false)
  productId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id])

  @@index([productId])
}

model ProductVariation {
  id             String   @id @default(uuid())
  attributeName  String
  attributeValue String
  price          Decimal  @db.Decimal(10, 2)
  quantity       Int
  isDelete       Boolean  @default(false)
  productId      String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  product      Product       @relation(fields: [productId], references: [id])
  orderDetails OrderDetail[]

  @@index([productId])
}

model Review {
  id         String   @id @default(uuid())
  reviewText String
  rating     Int
  reviewDate DateTime @default(now())
  productId  String
  userId     String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@index([productId])
  @@index([userId])
}

// ============================================
// COMMERCE
// ============================================

model Voucher {
  id             String   @id @default(uuid())
  code           String   @unique
  discount       Decimal  @db.Decimal(10, 2)
  expirationDate DateTime
  isUsed         Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model AddressBook {
  id            String   @id @default(uuid())
  recipientName String
  phoneNumber   String
  address       String
  ward          String
  district      String
  city          String
  email         String
  userId        String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user   User    @relation(fields: [userId], references: [id])
  orders Order[]

  @@index([userId])
}

model Order {
  id            String        @id @default(uuid())
  code          String        @unique
  date          DateTime      @default(now())
  note          String?
  paymentMethod PaymentMethod @default(COD)
  totalPrice    Decimal       @db.Decimal(10, 2)
  discount      Decimal       @default(0) @db.Decimal(10, 2)
  status        OrderStatus   @default(PENDING)
  userId        String
  addressBookId String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user         User          @relation(fields: [userId], references: [id])
  addressBook  AddressBook   @relation(fields: [addressBookId], references: [id])
  orderDetails OrderDetail[]

  @@index([userId])
  @@index([date])
  @@index([status])
}

model OrderDetail {
  id                 String   @id @default(uuid())
  quantity           Int
  price              Decimal  @db.Decimal(10, 2)
  orderId            String
  productId          String
  productVariationId String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  order            Order             @relation(fields: [orderId], references: [id])
  product          Product           @relation(fields: [productId], references: [id])
  productVariation ProductVariation? @relation(fields: [productVariationId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([productVariationId])
}

model New {
  id          String   @id @default(uuid())
  title       String
  content     String
  publishDate DateTime @default(now())
  isDeleted   Boolean  @default(false)
  image       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([publishDate])
}

// ============================================
// MESSAGING
// ============================================

model ChatRoom {
  id         String   @id @default(uuid())
  customerId String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  customer             User?                 @relation("CustomerChatRooms", fields: [customerId], references: [id])
  chatRoomParticipants ChatRoomParticipant[]
  messages             Message[]

  @@index([customerId])
}

// Explicit join table for many-to-many relationship
// Prisma 6 note: This explicit table avoids implicit m:n migration issues
model ChatRoomParticipant {
  id         String   @id @default(uuid())
  chatRoomId String
  userId     String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  chatRoom ChatRoom @relation(fields: [chatRoomId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@unique([chatRoomId, userId])
  @@index([chatRoomId])
  @@index([userId])
}

model Message {
  id         String   @id @default(uuid())
  content    String
  timestamp  DateTime @default(now())
  senderId   String?
  chatRoomId String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  sender   User?     @relation("SentMessages", fields: [senderId], references: [id])
  chatRoom ChatRoom? @relation(fields: [chatRoomId], references: [id])

  @@index([chatRoomId])
  @@index([senderId])
  @@index([timestamp])
}
